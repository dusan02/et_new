# =================================================
# COMMANDS TO RUN ON PRODUCTION SERVER
# =================================================
# Copy and paste these commands into your SSH session
# Server: 89.185.250.213 (logged in as root)

# 1. First, check current status
echo "=== Current Status Check ==="
pwd
ps aux | grep -E "(node|next|earnings)" | grep -v grep
ls -la /var/www/

# 2. Navigate to application directory
cd /var/www/earnings-table

# 3. Check if directory exists and show contents
pwd
ls -la

# 4. Stop any running processes
echo "=== Stopping existing processes ==="
pkill -f "next"
pkill -f "earnings"
systemctl stop earnings-table 2>/dev/null || echo "No systemd service to stop"

# 5. Check Node.js is available
echo "=== Checking Node.js ==="
node --version
npm --version

# 6. Install dependencies
echo "=== Installing dependencies ==="
npm ci --production

# 7. Generate Prisma client
echo "=== Generating Prisma client ==="
npx prisma generate

# 8. Build the application
echo "=== Building application ==="
npm run build

# 9. Verify build was successful
echo "=== Verifying build ==="
ls -la .next/
ls -la .next/server/app/

# 10. Check if the problematic file exists now
if [ -f ".next/server/app/page.js" ]; then
    echo "âœ… BUILD SUCCESS: page.js file exists!"
else
    echo "âŒ BUILD FAILED: page.js file missing"
    exit 1
fi

# 11. Start the application
echo "=== Starting application ==="
NODE_ENV=production nohup npm start > app.log 2>&1 &

# 12. Wait for startup
echo "=== Waiting for startup ==="
sleep 10

# 13. Test the application
echo "=== Testing application ==="
curl -f http://localhost:3000
echo ""
echo "=== Testing API ==="
curl -f http://localhost:3000/api/earnings

# 14. Show final status
echo "=== Final Status ==="
ps aux | grep node | grep -v grep
netstat -tlnp | grep :3000

echo ""
echo "ðŸŽ‰ If no errors above, your app should be working!"
echo "ðŸŒ Test it at: http://89.185.250.213:3000"
echo ""
echo "ðŸ“‹ To check logs: tail -f app.log"
echo "ðŸ“‹ To restart: pkill -f next && NODE_ENV=production nohup npm start > app.log 2>&1 &"
